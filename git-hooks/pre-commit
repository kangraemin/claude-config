#!/bin/bash
# git pre-commit hook: 워크로그를 커밋에 포함
# 글로벌 적용: git config --global core.hooksPath ~/.claude/git-hooks
#
# 워크로그 작성 주체:
#   - Claude /commit 플로우: Claude가 직접 작성 (요청사항, 작업요약, 토큰 등)
#   - auto-commit 등: 이 훅이 fallback으로 기본 정보만 작성

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || exit 0
DATE=$(date +"%Y-%m-%d")
TIME=$(date +"%H:%M:%S")

# staged 파일이 .worklogs/ 뿐이면 스킵 (무한루프 방지)
STAGED_NON_WORKLOG=$(git diff --cached --name-only | grep -v '.worklogs/')
[ -z "$STAGED_NON_WORKLOG" ] && exit 0

LOG_DIR="$REPO_ROOT/.worklogs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/${DATE}.md"

# 워크로그 파일이 이미 staged에 있으면 Claude가 작성한 것 → git add만
if git diff --cached --name-only | grep -q '.worklogs/'; then
  exit 0
fi

# --- fallback: Claude가 안 쓴 경우 (auto-commit 등) 기본 정보만 ---

CHANGED_FILES=$(git diff --cached --name-only)
FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
DIFF_STAT=$(git diff --cached --stat)

# 파일이 없으면 헤더 생성
if [ ! -f "$LOG_FILE" ]; then
  cat > "$LOG_FILE" << HEADER
# Worklog: $(basename "$REPO_ROOT") — $DATE

HEADER
fi

cat >> "$LOG_FILE" << ENTRY
---

## $TIME (auto)

### 변경된 파일 (${FILE_COUNT}개)
\`\`\`
$CHANGED_FILES
\`\`\`

### 변경 통계
\`\`\`
$DIFF_STAT
\`\`\`

ENTRY

git add "$LOG_FILE" 2>/dev/null

exit 0
