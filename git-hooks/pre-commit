#!/bin/bash
# git pre-commit hook: 커밋 직전에 워크로그 생성 → 같은 커밋에 포함
# 글로벌 적용: git config --global core.hooksPath ~/.claude/git-hooks

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || exit 0
DATE=$(date +"%Y-%m-%d")
TIME=$(date +"%H:%M:%S")

# staged 파일이 .worklogs/ 뿐이면 스킵 (무한루프 방지)
STAGED_NON_WORKLOG=$(git diff --cached --name-only | grep -v '.worklogs/')
[ -z "$STAGED_NON_WORKLOG" ] && exit 0

# --- 워크로그: 날짜별 단일 파일에 append ---
LOG_DIR="$REPO_ROOT/.worklogs"
mkdir -p "$LOG_DIR"

LOG_FILE="$LOG_DIR/${DATE}.md"

# staged 파일 목록
CHANGED_FILES=$(git diff --cached --name-only)
FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')

# staged diff 요약 (stat)
DIFF_STAT=$(git diff --cached --stat)

# staged diff 전체 (너무 길면 잘라냄)
DIFF_FULL=$(git diff --cached --no-color 2>/dev/null | head -200)
DIFF_LINES=$(git diff --cached --no-color 2>/dev/null | wc -l | tr -d ' ')
DIFF_TRUNCATED=""
[ "$DIFF_LINES" -gt 200 ] && DIFF_TRUNCATED=" (전체 ${DIFF_LINES}줄 중 200줄만 표시)"

# 파일이 없으면 헤더 생성
if [ ! -f "$LOG_FILE" ]; then
  cat > "$LOG_FILE" << HEADER
# Worklog: $(basename "$REPO_ROOT") — $DATE

HEADER
fi

# 커밋 엔트리 append
cat >> "$LOG_FILE" << ENTRY
---

## $TIME

### 변경된 파일 (${FILE_COUNT}개)
\`\`\`
$CHANGED_FILES
\`\`\`

### 변경 통계
\`\`\`
$DIFF_STAT
\`\`\`

### Diff${DIFF_TRUNCATED}
\`\`\`diff
$DIFF_FULL
\`\`\`

ENTRY

# 워크로그를 staging에 추가 → 같은 커밋에 포함됨
git add "$LOG_FILE" 2>/dev/null

exit 0
